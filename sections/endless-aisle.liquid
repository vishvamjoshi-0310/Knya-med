
{{ 'endless-aisle.css' | asset_url | stylesheet_tag }}

{% style %}
  .endless_aisle_order, .endless_aisle_address{display: none;}
    #{{ section.id }} {
      margin-top: {{section.settings.margin_top_desktop}}px;
      margin-bottom: {{section.settings.margin_bottom_desktop}}px;
    }
    @media(max-width: 600px){
        #{{ section.id }} {
      margin-top: {{section.settings.margin_top_Mobile}}px;
      margin-bottom: {{section.settings.margin_bottom_Mobile}}px;
    }
    }

  #{{ section.id }} h2, #{{ section.id }} h3 {
    font-family: 'Heebo-Medium';
    font-weight: 500;
  }
    #{{ section.id }} p {
    font-family: 'Heebo-Regular';
    font-weight: 400;
  }
    .endless_aisle_login{background: {{section.settings.color_back1}};}

  .ea-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    
    .ea-loader-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
{% endstyle %}

<section class="{{ section.id }} page-width" id="{{ section.id }}">
   <div id="ea-loader" class="ea-loader" style="display: none;">
    <div class="ea-loader-spinner"><p></p></div>
  </div>
  <div class="endless-aisle__maincontainer">
    <div class="endless-aisle__subcontainer">
      <div class="endless-aisle__logIncontainer">
        <div class="endless-aisle__login-container">
          <h2>Find Customer</h2>

           <label for="endlessAislInput">Email Address or Phone Number (do not use +91 at phone number)</label>
          <div class="input-wrapper">
            <input
              type="text"
              id="endlessAislInput"
              class="ea-input"
              placeholder="Enter email or phone number"
              oninput="validateInput(this)"
            >
          </div>
          <p id="endlessAislEmailError" class="error hidden">*Please enter a valid email or phone number</p>
          <button class="endless-aisle__login-btn" onclick="endlessAisehandleLogin()">Find Customer</button>

          <p class="endless-aisle__signup-text">
            Create a new account. <a href="#" onclick="showRegistrationModal(); return false;">Click Here</a>
          </p>
        </div>
      </div>
    </div>
  </div>
  <!-- second create -->
  <div
    id="registrationModal"
    class="ea-modal"
    style="display: none;"
    onclick="if(event.target===this)closeRegistrationModal()"
  >
    <div class="ea-modal-content" onclick="event.stopPropagation()">
      <button class="ea-modal-close" onclick="closeRegistrationModal()">
        Ã—
      </button>
      <h2>Create account</h2>
      <form id="registrationForm" class="ea-form" onsubmit="handleRegistration(event)">
        <div class="ea-form-grid_login">
          <div>
            <label>First Name<span class="required">*</span></label>
            <input
              type="text"
              class="ea-input"
              id="reg-firstname"
              required
              placeholder="First Name"
            >
          </div>
          <div>
            <label>Last Name<span class="required">*</span></label>
            <input
              type="text"
              class="ea-input"
              id="reg-lastname"
              required
              placeholder="Last Name"
            >
          </div>

          <div class="ea-form-full">
            <label>Address 1<span class="required">*</span></label>
            <input
              type="text"
              class="ea-input"
              id="reg-address1"
              required
              placeholder="Address 1"
            >
          </div>

          <div class="ea-form-full">
            <label>Address 2</label>
            <input
              type="text"
              class="ea-input"
              id="reg-address2"
              placeholder="Address 2"
            >
          </div>

          <div>
            <label>Select Country</label>
            <input type="text" class="ea-input" value="India" disabled>
          </div>

                  <div>
    <label>State</label>
    <select id="reg-province" class="ea-input" required>
      <option value="">Select State</option>
      <option>Andhra Pradesh</option>
      <option>Arunachal Pradesh</option>
      <option>Assam</option>
      <option>Bihar</option>
      <option>Chhattisgarh</option>
      <option>Goa</option>
      <option>Gujarat</option>
      <option>Haryana</option>
      <option>Himachal Pradesh</option>
      <option>Jharkhand</option>
      <option>Karnataka</option>
      <option>Kerala</option>
      <option>Madhya Pradesh</option>
      <option>Maharashtra</option>
      <option>Manipur</option>
      <option>Meghalaya</option>
      <option>Mizoram</option>
      <option>Nagaland</option>
      <option>Odisha</option>
      <option>Punjab</option>
      <option>Rajasthan</option>
      <option>Sikkim</option>
      <option>Tamil Nadu</option>
      <option>Telangana</option>
      <option>Tripura</option>
      <option>Uttar Pradesh</option>
      <option>Uttarakhand</option>
      <option>West Bengal</option>
      <!-- Union Territories -->
      <option>Andaman and Nicobar Islands</option>
      <option>Chandigarh</option>
      <option>Dadra and Nagar Haveli and Daman and Diu</option>
      <option>Delhi</option>
      <option>Lakshadweep</option>
      <option>Puducherry</option>
      <option>Ladakh</option>
      <option>Jammu and Kashmir</option>
    </select>
  </div>

          <div>
            <label>City<span class="required">*</span></label>
            <input
              type="text"
              class="ea-input"
              id="reg-city"
              required
              placeholder="City"
               pattern="[A-Za-z\s\-]+"
              onkeydown="return !/[0-9]/.test(event.key)"
            >
          </div>

          <div>
            <label>Postal code<span class="required">*</span></label>
            <input
              type="text"
              class="ea-input"
              id="reg-postal"
              required
              placeholder="Postal code"
               maxlength="6"
          inputmode="numeric"
          pattern="\d{6}"
          oninput="this.value = this.value.replace(/[^0-9]/g, '')" 
            >
          </div>

            <div class="ea-form-full">
            <label>Email Address<span class="required">*</span></label>
            <input
              type="email"
              class="ea-input"
              id="reg-email"
              required
              placeholder="Enter your email address"
              pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
              title="Please enter a valid email address"
            >
          </div>

          <div class="ea-form-full">
            <label>Phone Number<span class="required">*</span></label>
            <div class="phone-input-group">
              <input type="text" class="country-code-input" value="+91" disabled>
              <input
                type="tel"
                class="ea-input"
                id="reg-phone"
                required
                placeholder="XXXXX XXXXX"
                maxlength="10"
                pattern="[6-9][0-9]{9}"
                oninput="validateIndianPhonecreate(this); this.value = this.value.replace(/[^0-9]/g, '')""
              >
            </div>
          </div>
        </div>

        <button type="submit" class="ea-btn ea-btn-proceed" onclick="endlessAisehandlecraeteCustomer(event)">REGISTER</button>
      </form>
    </div>
  </div>
</section>
<script>
  window.showLoader = function() {
    document.getElementById('ea-loader').style.display = 'flex';
  }

   window.hideLoader = function() {
    document.getElementById('ea-loader').style.display = 'none';
  }
  function validateIndianPhonecreate(input) {
    try {
      const phoneNumber = input.value.replace(/\D/g, '');
      const isValid = /^[6-9]\d{9}$/.test(phoneNumber);

      if (isValid) {
        input.classList.remove('invalid');
        input.style.borderColor = '#ccc';
        document.getElementById('phone-error').style.display = 'none';
        input.setCustomValidity('');

        const formattedNumber = phoneNumber.replace(/(\d{5})(\d{5})/, '$1 $2');
        if (input.value !== formattedNumber) {
          input.value = formattedNumber;
        }
      } else {
        input.classList.add('invalid');
        input.style.borderColor = '#ff0000';
        document.getElementById('phone-error').style.display = 'block';
        input.setCustomValidity('Please enter a valid Indian mobile number');
      }
    } catch (error) {
      console.error("Error in validateIndianPhone:", error);
    }
  }
  
  function validateInput(input) {
  try {
    const value = input.value.trim();
    const emailRegex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
    const phoneRegex = /^[6-9]\d{9}$/;
    const error = document.getElementById('endlessAislEmailError');

    if (value.match(/^\d/)) {
      input.value = value.replace(/\D/g, '');
    }

    const isValidEmail = emailRegex.test(value);
    const isValidPhone = phoneRegex.test(value.replace(/\D/g, ''));

    if (isValidEmail || isValidPhone) {
      error.classList.add('hidden');
      input.classList.remove('invalid');
      return true;
    } else {
      error.classList.remove('hidden');
      input.classList.add('invalid');
      return false;
    }
  } catch (error) {
    console.error("validateInput error:", error);
    return false;
  }
}

function showRegistrationModal() {
  try {
    document.getElementById('registrationModal').style.display = 'flex';
    document.body.classList.add('modal-open-customer');
  } catch (error) {
    console.error("showRegistrationModal error:", error);
  }
}

function closeRegistrationModal() {
  try {
    document.getElementById('registrationModal').style.display = 'none';
    document.body.classList.remove('modal-open-customer');
  } catch (error) {
    console.error("closeRegistrationModal error:", error);
  }
}

function showSectionFromURL() {
  try {
    const params = new URLSearchParams(window.location.search);
    const sectionToShow = params.get("section");
    const allSections = document.querySelectorAll("#MainContent .shopify-section");

    allSections.forEach(section => section.style.display = "none");

    if (sectionToShow) {
      const targetSection = document.querySelector(`#MainContent .${CSS.escape(sectionToShow)}`);
      if (targetSection) targetSection.style.display = "block";
    }
  } catch (error) {
    console.error("showSectionFromURL error:", error);
  }
}

async function endlessAisehandleLogin() {
  try {
    showLoader();
      const cartResponse = await fetch('/cart.js');
    const cart = await cartResponse.json();
    
    if (!cart.items || cart.items.length === 0) {
      hideLoader();
      alert('Please add at least one product to cart before proceeding.');
      return;
    }
    document.querySelector("#endless-aisle__next-btn").setAttribute("disabled", true);

    const input = document.getElementById("endlessAislInput");
    const errorBox = document.getElementById("endlessAislEmailError");
    const value = input.value.trim();

    if (!validateInput(input)) return;

    const isEmail = value.includes('@');
    const formData = isEmail ? { email: value } : { phone: value };

    const aesKey = await generateAESKey();
    const encryptedAESKey = await encryptRSA(aesKey);
    const { encryptedData, iv } = await encryptAES(formData, aesKey);
    const encryptedPayload = { encryptedAESKey, encryptedData, iv };

    const response = await fetch('/apps/endless/api/customer/get', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },  
      body: JSON.stringify(encryptedPayload), 
    });

    if (!response.ok) {
      const errorRes = await response.json();
      console.error('Customer lookup failed:', errorRes);
       document.getElementById("endlessAislEmailError").textContent  = `*${errorRes.message}` || "*Something went wrong. Please try again.";
      throw new Error(`Status: ${response.status}`); 
    }

    const data = await response.json();    
    const decryptedString = atob(data.data); // now it's a decrypted string 
    const decryptedStringparsed = JSON.parse(decryptedString);

    window.result = decryptedStringparsed;
    const customerData = decryptedStringparsed;

    if (customerData && customerData.addresses.length > 0) {
      const newUrl = `${window.location.pathname}?section=endless_aisle_address`;
      window.history.pushState({}, "", newUrl);
      showSectionFromURL();

      document.querySelector("#endless-aisle__prev-btn").removeAttribute("disabled");
      document.getElementById("endless-aisle__customer-name").textContent = `${customerData.firstName} ${customerData.lastName}`;
      document.getElementById("endless-aisle__customer-email").textContent = customerData.email;

      const addressGrid = document.getElementById("endless-aisle__address-grid");
      addressGrid.innerHTML = "";

      customerData.addresses.forEach((addr, index) => {
        const card = document.createElement("div");
        card.className = "endless-aisle__card" + (index === 0 ? " endless-aisle__card--highlight" : "");
        card.innerHTML = `
          <strong>${addr.firstName} ${addr.lastName}</strong>
          <p>${addr.address1}${addr.address2 ? ", " + addr.address2 : ""}</p>
          ${addr.city || addr.province || addr.zip ? `<p>${[addr.city, addr.province, addr.zip].filter(Boolean).join(', ')}</p>` : ''}
          ${addr.country ? `<p>${addr.country}</p>` : ''}
          ${addr.phone ? `<p>${addr.phone}</p>` : ""}
        `;
        addressGrid.appendChild(card);
      });

    } else {
      errorBox.textContent = "*No customer found with that email.";
      errorBox.classList.remove("hidden");
    }
  } catch (error) {
    console.error("endlessAisehandleLogin error:", error);
    // document.getElementById("endlessAislEmailError").textContent = "*Something went wrong. Please try again.";
    document.getElementById("endlessAislEmailError").classList.remove("hidden");
  } finally {
    hideLoader(); // Hide loader when done
  }
}

function goBackToLogin() {
  try {
    if (window.history.length > 1) {
      window.history.back();
      setTimeout(() => showSectionFromURL(), 500);
    }
  } catch (error) {
    console.error("goBackToLogin error:", error);
  }
}

function goNextToLogin() {
  try {
    const newUrl = `${window.location.pathname}?section=endless_aisle_order`;
    window.history.pushState({}, "", newUrl);
    showSectionFromURL();
  } catch (error) {
    console.error("goNextToLogin error:", error);
  }
}

async function endlessAisehandlecraeteCustomer(event) {
  try {
    event.preventDefault();
    showLoader();
    
    // Get all form values
    const firstName = document.getElementById('reg-firstname').value.trim();
    const lastName = document.getElementById('reg-lastname').value.trim();
    const email = document.getElementById('reg-email').value.trim();
    const phone = document.getElementById('reg-phone').value.replace(/\D/g, '');
    const address1 = document.getElementById('reg-address1').value.trim();
    const address2 = document.getElementById('reg-address2').value.trim();
    const city = document.getElementById('reg-city').value.trim();
    const province = document.getElementById('reg-province').value.trim();
    const zip = document.getElementById('reg-postal').value.trim();

    // Basic validation
    if (!firstName || !lastName || !email || !phone || !address1 || !city || !province || !zip) {
      alert('Please fill in all required fields');
     hideLoader();
      return;
    }

    // Email validation
    const emailRegex = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;
    if (!emailRegex.test(email)) {
      alert('Please enter a valid email address');
      hideLoader();
      return;
      
    }

    // Phone validation
    const phoneRegex = /^[6-9]\d{9}$/;
    if (!phoneRegex.test(phone)) {
      alert('Please enter a valid Indian phone number');
       hideLoader();
      return;
    }

    // Prepare request data
    const requestData = {
      email,
      phone,
      firstName,
      lastName,
      addresses: {
        address1,
        address2,
        city,
        countryCode: "IN",
        province,
        phone,
        zip
      }
    };

    const aesKey = await generateAESKey();
    const encryptedAESKey = await encryptRSA(aesKey);
    const { encryptedData, iv } = await encryptAES(requestData, aesKey);
    const requestDataencryptedPayload = { encryptedAESKey, encryptedData, iv };

    // API call
    const response = await fetch("/apps/endless/api/customer/create", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(requestDataencryptedPayload)
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'Failed to create customer');
    }

    const result = await response.json();
    
    // Close modal and show success message
    closeRegistrationModal();
   const searchInput = document.getElementById('endlessAislInput');
    searchInput.value = email;
    
    // Add delay before searching
     setTimeout(async () => {
      await endlessAisehandleLogin();
    }, 5000);
    
    // Optional: Clear form
    document.getElementById('registrationForm').reset();

  } catch (error) {
    console.error("Error creating customer:", error);
    alert(error.message || 'Failed to create customer. Please try again.');
     hideLoader();
  }
}
</script>

{% schema %}
{
  "name": "endless-aisle",
  "class": "endless_aisle_login",
  "settings": [
    {
          "type": "color",
          "id": "color_back1",
          "label": "Body background color for login",
          "default": "#fffefb"
        },
     {
      "type": "range",
      "id": "margin_bottom_desktop",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Bottom Desktop",
      "default": 36
    },
     {
      "type": "range",
      "id": "margin_top_desktop",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Top Desktop",
      "default": 36
    },
     {
      "type": "range",
      "id": "margin_bottom_Mobile",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Bottom Mobile",
      "default": 20
    },
     {
      "type": "range",
      "id": "margin_top_Mobile",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Top Desktop",
      "default": 20
    }
  ],
  "presets": [{
    "name": "endless-aisle"
  }]
}
{% endschema %}
