{{ 'section-breakpoint-why-exists.css' | asset_url | stylesheet_tag }}

<section class="breakpoint-why-exists-section">
  {%- if section.settings.background_image_desktop != blank or section.settings.background_image_mobile != blank -%}
    <div class="breakpoint-why-exists-background">
      <picture>
        {%- if section.settings.background_image_mobile != blank -%}
          <source
            media="(max-width: 768px)"
            srcset="{{ section.settings.background_image_mobile | image_url: width: 2000 }}"
          >
        {%- endif -%}
        {%- if section.settings.background_image_desktop != blank -%}
          <source
            media="(min-width: 769px)"
            srcset="{{ section.settings.background_image_desktop | image_url: width: 2000 }}"
          >
        {%- endif -%}
        {%- liquid
          if section.settings.background_image_desktop != blank
            assign bg_image = section.settings.background_image_desktop
          else
            assign bg_image = section.settings.background_image_mobile
          endif
        -%}
        {{
          bg_image
          | image_url: width: 2000
          | image_tag:
            loading: 'lazy',
            width: bg_image.width,
            height: bg_image.height,
            alt: bg_image.alt
        }}
      </picture>
    </div>
  {%- endif -%}

  <div class="breakpoint-why-exists-content">
    {%- if section.settings.heading != blank -%}
      <h2 class="breakpoint-why-exists-heading">{{ section.settings.heading }}</h2>
    {%- endif -%}

    <div class="breakpoint-why-exists-layout">
      <div class="breakpoint-why-exists-left">
        <div class="breakpoint-why-exists-slider breakpoint-why-exists-slider-{{ section.id }}">
          <div class="breakpoint-why-exists-slider-wrapper">
            {%- for block in section.blocks -%}
              {%- if block.settings.card_image != blank -%}
                {%- liquid
                  assign card_image = block.settings.card_image
                  assign card_width = 1200
                  assign card_height = card_width | divided_by: card_image.aspect_ratio | round
                -%}
                <img
                  loading="lazy"
                  src="{{ card_image | image_url: width: card_width }}"
                  width="{{ card_width }}"
                  height="{{ card_height }}"
                  alt="{{ card_image.alt | escape }}"
                  class="breakpoint-why-exists-slider-image"
                >
              {%- endif -%}
            {%- endfor -%}
          </div>
          <div class="breakpoint-why-exists-slider-pagination"></div>
        </div>
      </div>

      <div class="breakpoint-why-exists-right">
        {%- if section.settings.description_text_before != blank -%}
          <div class="breakpoint-why-exists-description-before">{{ section.settings.description_text_before }}</div>
        {%- endif -%}

        {%- if section.settings.vitals_logo_desktop != blank or section.settings.vitals_logo_mobile != blank -%}
          <div class="breakpoint-why-exists-vitals">
            <picture>
              {%- if section.settings.vitals_logo_mobile != blank -%}
                <source
                  media="(max-width: 768px)"
                  srcset="{{ section.settings.vitals_logo_mobile | image_url: width: 800 }}"
                >
              {%- endif -%}
              {%- if section.settings.vitals_logo_desktop != blank -%}
                <source
                  media="(min-width: 769px)"
                  srcset="{{ section.settings.vitals_logo_desktop | image_url: width: 2000 }}"
                >
              {%- endif -%}
              {%- liquid
                if section.settings.vitals_logo_desktop != blank
                  assign vitals_image = section.settings.vitals_logo_desktop
                  assign vitals_width = 2000
                else
                  assign vitals_image = section.settings.vitals_logo_mobile
                  assign vitals_width = 800
                endif
                assign vitals_height = vitals_width | divided_by: vitals_image.aspect_ratio | round
              -%}
              <img
                loading="lazy"
                src="{{ vitals_image | image_url: width: vitals_width }}"
                width="{{ vitals_width }}"
                height="{{ vitals_height }}"
                alt="{{ vitals_image.alt | escape }}"
              >
            </picture>
          </div>
        {%- endif -%}

        {%- if section.settings.description_text_after != blank -%}
          <div class="breakpoint-why-exists-description-after">{{ section.settings.description_text_after }}</div>
        {%- endif -%}

        {%- if section.settings.breakpoint_statement != blank -%}
          <div class="breakpoint-why-exists-statement">{{ section.settings.breakpoint_statement }}</div>
        {%- endif -%}

        {%- if section.settings.action_text != blank -%}
          <div class="breakpoint-why-exists-action">
            <a href="{{ section.settings.action_link }}" class="breakpoint-why-exists-link">
              {{ section.settings.action_text }}
              {%- if section.settings.action_icon_svg != blank -%}
                {{ section.settings.action_icon_svg }}
              {%- endif -%}
            </a>
          </div>
        {%- endif -%}
      </div>
    </div>
  </div>
</section>

<script>
  (function () {
    var slider = document.querySelector('.breakpoint-why-exists-slider-{{ section.id }}');
    if (!slider) return;

    var wrapper = slider.querySelector('.breakpoint-why-exists-slider-wrapper');
    var slides = slider.querySelectorAll('.breakpoint-why-exists-slider-image');
    var pagination = slider.querySelector('.breakpoint-why-exists-slider-pagination');
    var currentIndex = 0;
    var isDragging = false;
    var startX = 0;
    var currentX = 0;
    var translateX = 0;
    var isMobile = window.innerWidth <= 768;

    if (slides.length === 0) return;

    function createPagination() {
      if (!pagination) return;
      pagination.innerHTML = '';
      for (var i = 0; i < slides.length; i++) {
        var dot = document.createElement('span');
        dot.className = 'breakpoint-why-exists-pagination-dot';
        if (i === 0) dot.classList.add('active');
        dot.addEventListener(
          'click',
          (function (index) {
            return function () {
              goToSlide(index);
            };
          })(i)
        );
        pagination.appendChild(dot);
      }
    }

    function updatePagination() {
      if (!pagination) return;
      var dots = pagination.querySelectorAll('.breakpoint-why-exists-pagination-dot');
      dots.forEach(function (dot, index) {
        dot.classList.toggle('active', index === currentIndex);
      });
    }

    function goToSlide(index) {
      if (index < 0 || index >= slides.length) return;
      currentIndex = index;
      updateSlider();
      updatePagination();
    }

    function updateSlider() {
      // Get the actual rendered width of the first image
      var slideWidth = slides.length > 0 ? slides[0].offsetWidth : slider.clientWidth;
      var gap = 60; // Gap between slides from CSS
      var totalSlideWidth = slideWidth + gap;
      translateX = -currentIndex * totalSlideWidth;
      wrapper.style.transition = 'transform 0.3s ease';
      wrapper.style.transform = 'translateX(' + translateX + 'px)';
    }

    function handleTouchStart(e) {
      isDragging = true;
      startX = e.touches ? e.touches[0].clientX : e.clientX;
      var slideWidth = slides.length > 0 ? slides[0].offsetWidth : slider.clientWidth;
      var gap = 60;
      translateX = -currentIndex * (slideWidth + gap);
      wrapper.style.transition = 'none';
    }

    function handleTouchMove(e) {
      if (!isDragging) return;
      currentX = e.touches ? e.touches[0].clientX : e.clientX;
      var diff = currentX - startX;
      var slideWidth = slides.length > 0 ? slides[0].offsetWidth : slider.clientWidth;
      var gap = 60;
      var totalSlideWidth = slideWidth + gap;
      var newTranslateX = translateX + diff;

      var minTranslate = -(slides.length - 1) * totalSlideWidth;
      if (newTranslateX > 0) newTranslateX = 0;
      if (newTranslateX < minTranslate) newTranslateX = minTranslate;

      wrapper.style.transform = 'translateX(' + newTranslateX + 'px)';
    }

    function handleTouchEnd(e) {
      if (!isDragging) return;
      isDragging = false;
      wrapper.style.transition = 'transform 0.3s ease';

      var slideWidth = slides.length > 0 ? slides[0].offsetWidth : slider.clientWidth;
      var diff = currentX - startX;
      var threshold = slideWidth * 0.3;

      if (Math.abs(diff) > threshold) {
        if (diff > 0 && currentIndex > 0) {
          goToSlide(currentIndex - 1);
        } else if (diff < 0 && currentIndex < slides.length - 1) {
          goToSlide(currentIndex + 1);
        } else {
          updateSlider();
        }
      } else {
        updateSlider();
      }
    }

    function handleMouseDown(e) {
      handleTouchStart(e);
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
    }

    function handleMouseMove(e) {
      handleTouchMove(e);
    }

    function handleMouseUp(e) {
      handleTouchEnd(e);
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);
    }

    function init() {
      createPagination();
      updateSlider();

      wrapper.addEventListener('touchstart', handleTouchStart);
      wrapper.addEventListener('touchmove', handleTouchMove);
      wrapper.addEventListener('touchend', handleTouchEnd);
      wrapper.addEventListener('mousedown', handleMouseDown);

      window.addEventListener('resize', function () {
        updateSlider();
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

{% schema %}
{
  "name": "Breakpoint Why Exists",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Why Breakpoint exists"
    },
    {
      "type": "image_picker",
      "id": "background_image_desktop",
      "label": "Background Image Desktop"
    },
    {
      "type": "image_picker",
      "id": "background_image_mobile",
      "label": "Background Image Mobile"
    },
    {
      "type": "image_picker",
      "id": "vitals_logo_desktop",
      "label": "Vitals Logo Desktop"
    },
    {
      "type": "image_picker",
      "id": "vitals_logo_mobile",
      "label": "Vitals Logo Mobile"
    },
    {
      "type": "textarea",
      "id": "description_text_before",
      "label": "Description Text (Before Logo)",
      "default": "In 2025, Knya conducted,"
    },
    {
      "type": "textarea",
      "id": "description_text_after",
      "label": "Description Text (After Logo)",
      "default": "a nationwide study built on responses from 10,000+ medical professionals across India."
    },
    {
      "type": "textarea",
      "id": "breakpoint_statement",
      "label": "Breakpoint Statement (Bold Text)",
      "default": "Breakpoint is our way of acting on what we observed and heard."
    },
    {
      "type": "text",
      "id": "action_text",
      "label": "Action Link Text",
      "default": "Read Vital 2025"
    },
    {
      "type": "url",
      "id": "action_link",
      "label": "Action Link URL"
    },
    {
      "type": "html",
      "id": "action_icon_svg",
      "label": "Action Icon SVG",
      "info": "Paste SVG code for the arrow icon"
    }
  ],
  "blocks": [
    {
      "type": "stat_card",
      "name": "Statistic Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "card_image",
          "label": "Card Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Breakpoint Why Exists",
      "blocks": [
        {
          "type": "stat_card"
        }
      ]
    }
  ]
}
{% endschema %}
